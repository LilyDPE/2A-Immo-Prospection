<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DPE Pro">
    <link rel="apple-touch-icon" href="icon-512.png">
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#667eea">
    <title>DPE Prospection Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f7;
            overflow-x: hidden;
            padding-bottom: 70px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 20px 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 700;
        }

        .header p {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .container {
            padding: 15px;
        }

        .search-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
            background: white;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .filter-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #555;
            font-size: 0.9em;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .checkbox-item:active {
            transform: scale(0.95);
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"]:checked + label {
            color: #667eea;
            font-weight: 600;
        }

        .checkbox-item.checked {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .range-inputs {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
        }

        .range-separator {
            color: #999;
            font-weight: 600;
        }

        .tolerance-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tolerance-input input {
            flex: 1;
        }

        .tolerance-input span {
            color: #667eea;
            font-weight: 600;
            font-size: 1.1em;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
            margin-top: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .results-count {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .dpe-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
        }

        .dpe-card.has-note {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .dpe-address {
            font-weight: 600;
            font-size: 1.05em;
            margin-bottom: 8px;
            color: #333;
        }

        .dpe-info {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .dpe-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .dpe-A { background: #00A357; color: white; }
        .dpe-B { background: #4DB848; color: white; }
        .dpe-C { background: #C8D200; color: #333; }
        .dpe-D { background: #FDEE00; color: #333; }
        .dpe-E { background: #FCAF17; color: white; }
        .dpe-F { background: #EF6F1A; color: white; }
        .dpe-G { background: #E2001A; color: white; }

        .status-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin: 12px 0;
        }

        .status-btn {
            padding: 8px 4px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .status-btn.active {
            border-width: 3px;
            font-weight: 600;
        }

        .status-btn.to-visit.active { border-color: #007bff; color: #007bff; background: #e7f3ff; }
        .status-btn.visited.active { border-color: #28a745; color: #28a745; background: #e7f9ec; }
        .status-btn.interested.active { border-color: #ffc107; color: #cc9900; background: #fff8e1; }
        .status-btn.not-interested.active { border-color: #dc3545; color: #dc3545; background: #ffe7e9; }

        .note-input {
            width: 100%;
            min-height: 60px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9em;
            resize: vertical;
            font-family: inherit;
        }

        .note-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-export {
            background: #28a745;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .info-text {
            background: #e7f3ff;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9em;
            color: #0066cc;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè† DPE Pro</h1>
        <p>Prospection immobili√®re intelligente</p>
    </div>

    <div class="container">
        <!-- √âcran de recherche -->
        <div id="searchScreen" class="screen active">
            <div class="search-card">
                <div class="form-group">
                    <label>üìç Code postal</label>
                    <input type="text" id="codePostal" placeholder="76260" value="76260">
                </div>

                <div class="form-group">
                    <label>üìÖ Ann√©e</label>
                    <select id="annee">
                        <option value="">Toutes les ann√©es</option>
                        <option value="2025" selected>2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>üìÜ Mois (optionnel)</label>
                    <select id="mois">
                        <option value="">Tous les mois</option>
                        <option value="01">Janvier</option>
                        <option value="02">F√©vrier</option>
                        <option value="03">Mars</option>
                        <option value="04">Avril</option>
                        <option value="05">Mai</option>
                        <option value="06">Juin</option>
                        <option value="07">Juillet</option>
                        <option value="08">Ao√ªt</option>
                        <option value="09">Septembre</option>
                        <option value="10">Octobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">D√©cembre</option>
                    </select>
                </div>

                <!-- FILTRE CLASSE √âNERG√âTIQUE CORRIG√â -->
                <div class="filter-group">
                    <div class="filter-title">üîã Classe √©nerg√©tique</div>
                    <div class="checkbox-group">
                        <div class="checkbox-item checked" onclick="toggleCheckboxClasse('classeTout')" style="flex: 0 0 100%; margin-bottom: 5px; border-color: #667eea; background: #f0f3ff;">
                            <input type="checkbox" id="classeTout" checked>
                            <label for="classeTout" style="color: #667eea; font-weight: 600;">‚úì Toutes les classes</label>
                        </div>
                        <div class="checkbox-item" onclick="toggleCheckboxClasse('classeA')">
                            <input type="checkbox" id="classeA">
                            <label for="classeA">A</label>
                        </div>
                        <div class="checkbox-item" onclick="toggleCheckboxClasse('classeB')">
                            <input type="checkbox" id="classeB">
                            <label for="classeB">B</label>
                        </div>
                        <div class="checkbox-item" onclick="toggleCheckboxClasse('classeC')">
                            <input type="checkbox" id="classeC">
                            <label for="classeC">C</label>
                        </div>
                        <!-- CLASSE D AJOUT√âE -->
                        <div class="checkbox-item" onclick="toggleCheckboxClasse('classeD')">
                            <input type="checkbox" id="classeD">
                            <label for="classeD">D</label>
                        </div>
                        <div class="checkbox-item" onclick="toggleCheckboxClasse('classeE')">
                            <input type="checkbox" id="classeE">
                            <label for="classeE">E</label>
                        </div>
                        <div class="checkbox-item" onclick="toggleCheckboxClasse('classeF')">
                            <input type="checkbox" id="classeF">
                            <label for="classeF">F</label>
                        </div>
                        <div class="checkbox-item" onclick="toggleCheckboxClasse('classeG')">
                            <input type="checkbox" id="classeG">
                            <label for="classeG">G</label>
                        </div>
                    </div>
                </div>

                <!-- NOUVEAU FILTRE SURFACE HABITABLE -->
                <div class="filter-group">
                    <div class="filter-title">üìè Surface habitable (m¬≤)</div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <input type="number" id="surfaceReference" placeholder="Surface de r√©f√©rence (ex: 100)" min="0">
                    </div>
                    <div class="tolerance-input">
                        <label style="margin: 0;">Tol√©rance ¬±</label>
                        <input type="number" id="surfaceTolerance" placeholder="%" min="0" max="100" value="10">
                        <span>%</span>
                    </div>
                    <div class="info-text" id="surfaceRange"></div>
                </div>

                <button class="btn" onclick="searchDPE()">üîç Rechercher</button>
            </div>
        </div>

        <!-- √âcran de chargement -->
        <div id="loadingScreen" class="screen">
            <div class="loading">
                <div class="spinner"></div>
                <p>Recherche en cours...</p>
            </div>
        </div>

        <!-- √âcran de r√©sultats -->
        <div id="resultsScreen" class="screen">
            <div class="search-card">
                <div class="results-header">
                    <div class="results-count" id="resultsCount"></div>
                </div>
                <button class="btn" onclick="showItinerary()">üó∫Ô∏è Cr√©er l'itin√©raire</button>
                <button class="btn btn-export" onclick="exportCSV()">üì• Export CSV</button>
                <button class="btn btn-secondary" onclick="showSearchScreen()">üîô Nouvelle recherche</button>
            </div>

            <div id="resultsList"></div>
        </div>
    </div>

    <script>
        let allDPE = [];
        let currentFilter = 'all';
        let notes = {};
        let statuses = {};

        // Charger les donn√©es sauvegard√©es
        function loadSavedData() {
            const savedNotes = localStorage.getItem('dpe_notes');
            const savedStatuses = localStorage.getItem('dpe_statuses');
            if (savedNotes) notes = JSON.parse(savedNotes);
            if (savedStatuses) statuses = JSON.parse(savedStatuses);
        }

        // Sauvegarder les donn√©es
        function saveData() {
            localStorage.setItem('dpe_notes', JSON.stringify(notes));
            localStorage.setItem('dpe_statuses', JSON.stringify(statuses));
        }

        function toggleCheckbox(id) {
            const checkbox = document.getElementById(id);
            checkbox.checked = !checkbox.checked;
            checkbox.parentElement.classList.toggle('checked', checkbox.checked);
        }

        function toggleCheckboxClasse(id) {
            const checkbox = document.getElementById(id);
            checkbox.checked = !checkbox.checked;
            checkbox.parentElement.classList.toggle('checked', checkbox.checked);

            // Si on coche "Toutes les classes", on d√©coche toutes les autres
            if (id === 'classeTout' && checkbox.checked) {
                ['A', 'B', 'C', 'D', 'E', 'F', 'G'].forEach(classe => {
                    const cb = document.getElementById('classe' + classe);
                    cb.checked = false;
                    cb.parentElement.classList.remove('checked');
                });
            } 
            // Si on coche une classe sp√©cifique, on d√©coche "Toutes les classes"
            else if (id !== 'classeTout' && checkbox.checked) {
                const cbTout = document.getElementById('classeTout');
                cbTout.checked = false;
                cbTout.parentElement.classList.remove('checked');
            }
            // Si on d√©coche toutes les classes individuelles, on recoche "Toutes"
            else if (id !== 'classeTout' && !checkbox.checked) {
                const anyChecked = ['A', 'B', 'C', 'D', 'E', 'F', 'G'].some(classe => 
                    document.getElementById('classe' + classe).checked
                );
                if (!anyChecked) {
                    const cbTout = document.getElementById('classeTout');
                    cbTout.checked = true;
                    cbTout.parentElement.classList.add('checked');
                }
            }
        }

        // Initialiser les checkboxes
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
            updateSurfaceRange();
        });

        // Mettre √† jour la plage de surface
        function updateSurfaceRange() {
            const surfaceRef = document.getElementById('surfaceReference').value;
            const tolerance = document.getElementById('surfaceTolerance').value || 10;
            const rangeDiv = document.getElementById('surfaceRange');
            
            if (surfaceRef) {
                const min = Math.round(surfaceRef * (1 - tolerance / 100));
                const max = Math.round(surfaceRef * (1 + tolerance / 100));
                rangeDiv.textContent = `Recherche entre ${min} m¬≤ et ${max} m¬≤`;
                rangeDiv.style.display = 'block';
            } else {
                rangeDiv.textContent = '';
            }
        }

        document.getElementById('surfaceReference').addEventListener('input', updateSurfaceRange);
        document.getElementById('surfaceTolerance').addEventListener('input', updateSurfaceRange);

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showSearchScreen() {
            showScreen('searchScreen');
        }

        async function searchDPE() {
            const codePostal = document.getElementById('codePostal').value;
            const annee = document.getElementById('annee').value;
            const mois = document.getElementById('mois').value;

            if (!codePostal) {
                alert('Veuillez entrer un code postal');
                return;
            }

            showScreen('loadingScreen');

            try {
                // Construction de l'URL avec filtres
                let url = `https://data.ademe.fr/data-fair/api/v1/datasets/dpe-v2-logements-existants/lines?Code_postal_(BAN)=${codePostal}&size=10000`;
                
                if (annee) {
                    const dateDebut = mois ? `${annee}-${mois}-01` : `${annee}-01-01`;
                    const dateFin = mois ? `${annee}-${mois}-31` : `${annee}-12-31`;
                    url += `&Date_√©tablissement_DPE_gte=${dateDebut}&Date_√©tablissement_DPE_lte=${dateFin}`;
                }

                const response = await fetch(url);
                const data = await response.json();
                
                allDPE = data.results || [];

                // Appliquer les filtres
                allDPE = filterDPE(allDPE);

                if (allDPE.length === 0) {
                    alert('Aucun DPE trouv√© pour ces crit√®res');
                    showSearchScreen();
                    return;
                }

                // Trier par rue puis par num√©ro
                allDPE.sort((a, b) => {
                    const rueA = (a['Nom_rue_(BAN)'] || '').toLowerCase();
                    const rueB = (b['Nom_rue_(BAN)'] || '').toLowerCase();
                    if (rueA !== rueB) return rueA.localeCompare(rueB);
                    const numA = parseInt(a['N¬∞_(BAN)'] || '0');
                    const numB = parseInt(b['N¬∞_(BAN)'] || '0');
                    return numA - numB;
                });

                displayResults();
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la recherche');
                showSearchScreen();
            }
        }

        function filterDPE(dpes) {
            let filtered = [...dpes];

            // Filtre classe √©nerg√©tique
            const toutesLesClasses = document.getElementById('classeTout').checked;
            
            if (!toutesLesClasses) {
                const selectedClasses = [];
                ['A', 'B', 'C', 'D', 'E', 'F', 'G'].forEach(classe => {
                    if (document.getElementById(`classe${classe}`).checked) {
                        selectedClasses.push(classe);
                    }
                });

                if (selectedClasses.length > 0) {
                    filtered = filtered.filter(dpe => 
                        selectedClasses.includes(dpe['Etiquette_DPE'])
                    );
                }
            }

            // NOUVEAU: Filtre surface habitable
            const surfaceRef = parseFloat(document.getElementById('surfaceReference').value);
            const tolerance = parseFloat(document.getElementById('surfaceTolerance').value) || 10;

            if (surfaceRef && surfaceRef > 0) {
                const minSurface = surfaceRef * (1 - tolerance / 100);
                const maxSurface = surfaceRef * (1 + tolerance / 100);

                filtered = filtered.filter(dpe => {
                    const surface = parseFloat(dpe['Surface_habitable_logement']);
                    return surface >= minSurface && surface <= maxSurface;
                });
            }

            return filtered;
        }

        function displayResults() {
            const count = allDPE.length;
            document.getElementById('resultsCount').textContent = `${count} r√©sultat${count > 1 ? 's' : ''} trouv√©${count > 1 ? 's' : ''}`;

            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';

            allDPE.forEach((dpe, index) => {
                const card = createDPECard(dpe, index);
                resultsList.appendChild(card);
            });

            showScreen('resultsScreen');
        }

        function createDPECard(dpe, index) {
            const card = document.createElement('div');
            card.className = 'dpe-card';
            card.id = `dpe-${index}`;

            const adresse = `${dpe['N¬∞_(BAN)'] || ''} ${dpe['Nom_rue_(BAN)'] || ''}, ${dpe['Code_postal_(BAN)']} ${dpe['Nom_commune_(BAN)']}`.trim();
            const dpeKey = adresse;

            if (notes[dpeKey]) {
                card.classList.add('has-note');
            }

            const surface = dpe['Surface_habitable_logement'] ? `${Math.round(dpe['Surface_habitable_logement'])} m¬≤` : 'N/A';
            const conso = dpe['Conso_5_usages_√©_finale'] ? `${Math.round(dpe['Conso_5_usages_√©_finale'])} kWh/m¬≤/an` : 'N/A';

            card.innerHTML = `
                <div class="dpe-address">${adresse}</div>
                <div class="dpe-info">
                    <span class="dpe-badge dpe-${dpe['Etiquette_DPE']}">${dpe['Etiquette_DPE']}</span>
                    <span class="dpe-badge" style="background: #6c757d; color: white;">GES: ${dpe['Etiquette_GES'] || 'N/A'}</span>
                    <span class="dpe-badge" style="background: #17a2b8; color: white;">${surface}</span>
                    <span class="dpe-badge" style="background: #fd7e14; color: white;">${conso}</span>
                </div>

                <div class="status-buttons">
                    <button class="status-btn to-visit ${statuses[dpeKey] === 'to-visit' ? 'active' : ''}" 
                            onclick="setStatus('${dpeKey}', 'to-visit', ${index})">
                        üìç √Ä visiter
                    </button>
                    <button class="status-btn visited ${statuses[dpeKey] === 'visited' ? 'active' : ''}" 
                            onclick="setStatus('${dpeKey}', 'visited', ${index})">
                        ‚úÖ Visit√©
                    </button>
                    <button class="status-btn interested ${statuses[dpeKey] === 'interested' ? 'active' : ''}" 
                            onclick="setStatus('${dpeKey}', 'interested', ${index})">
                        ‚≠ê Int√©ress√©
                    </button>
                    <button class="status-btn not-interested ${statuses[dpeKey] === 'not-interested' ? 'active' : ''}" 
                            onclick="setStatus('${dpeKey}', 'not-interested', ${index})">
                        ‚ùå Pas int√©r.
                    </button>
                </div>

                <textarea class="note-input" placeholder="Ajouter une note..." 
                          onchange="saveNote('${dpeKey}', this.value, ${index})">${notes[dpeKey] || ''}</textarea>
            `;

            return card;
        }

        function setStatus(dpeKey, status, index) {
            if (statuses[dpeKey] === status) {
                delete statuses[dpeKey];
            } else {
                statuses[dpeKey] = status;
            }
            saveData();

            const card = document.getElementById(`dpe-${index}`);
            card.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            if (statuses[dpeKey]) {
                card.querySelector(`.status-btn.${status}`).classList.add('active');
            }
        }

        function saveNote(dpeKey, note, index) {
            if (note.trim()) {
                notes[dpeKey] = note;
                document.getElementById(`dpe-${index}`).classList.add('has-note');
            } else {
                delete notes[dpeKey];
                document.getElementById(`dpe-${index}`).classList.remove('has-note');
            }
            saveData();
        }

        function showItinerary() {
            if (allDPE.length === 0) return;

            const addresses = allDPE.map(dpe => {
                const num = dpe['N¬∞_(BAN)'] || '';
                const rue = dpe['Nom_rue_(BAN)'] || '';
                const cp = dpe['Code_postal_(BAN)'];
                const ville = dpe['Nom_commune_(BAN)'];
                return `${num} ${rue}, ${cp} ${ville}`.trim();
            });

            const waypoints = addresses.map(addr => 
                `&waypoints=${encodeURIComponent(addr)}`
            ).join('');

            const url = `https://www.google.com/maps/dir/?api=1&travelmode=driving&waypoint_optimization=true${waypoints}`;
            window.open(url, '_blank');
        }

        function exportCSV() {
            if (allDPE.length === 0) return;

            let csv = 'Adresse;DPE;GES;Surface (m¬≤);Conso (kWh/m¬≤/an);Type;Statut;Note\n';

            allDPE.forEach(dpe => {
                const adresse = `${dpe['N¬∞_(BAN)'] || ''} ${dpe['Nom_rue_(BAN)'] || ''}, ${dpe['Code_postal_(BAN)']} ${dpe['Nom_commune_(BAN)']}`.trim();
                const surface = dpe['Surface_habitable_logement'] || '';
                const conso = dpe['Conso_5_usages_√©_finale'] || '';
                const type = dpe['Type_b√¢timent'] || '';
                const status = statuses[adresse] || '';
                const note = (notes[adresse] || '').replace(/;/g, ',');

                csv += `${adresse};${dpe['Etiquette_DPE']};${dpe['Etiquette_GES']};${surface};${conso};${type};${status};${note}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const codePostal = document.getElementById('codePostal').value;
            const annee = document.getElementById('annee').value;
            link.href = URL.createObjectURL(blob);
            link.download = `dpe_${codePostal}_${annee}.csv`;
            link.click();
        }
    </script>
</body>
</html>

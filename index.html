<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DPE Pro - Version Mega Ultime</title>
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    
    <!-- Leaflet CSS pour la carte -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --success: #38ef7d;
            --warning: #fdb913;
            --danger: #f85032;
            --info: #4facfe;
            --light: #f8f9fa;
            --dark: #2d3748;
            --gray: #718096;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            margin-top: 10px;
            font-size: 14px;
            color: var(--gray);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: var(--light);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .auth-screen, .main-content {
            display: none;
        }

        .auth-screen.active, .main-content.active {
            display: block;
        }

        /* Login Form */
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 100px auto;
        }

        .login-card h2 {
            color: var(--primary);
            margin-bottom: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        /* Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            color: var(--gray);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item-icon {
            font-size: 24px;
            display: block;
            margin-bottom: 4px;
        }

        /* Search Section */
        .search-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .search-section h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 20px;
        }

        /* Results */
        .legend {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .legend h3 {
            font-size: 16px;
            color: var(--dark);
            margin-bottom: 12px;
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }

        .legend-sample {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .legend-sample.new {
            background: white;
            border-left-color: var(--info);
        }

        .legend-sample.interested {
            background: #f0fff4;
            border-left-color: var(--success);
        }

        .legend-sample.visited-other {
            background: #fffbf0;
            border-left-color: var(--warning);
            opacity: 0.7;
        }

        .legend-sample.visited-me {
            background: #f5f5f5;
            border-left-color: var(--gray);
            opacity: 0.6;
        }

        .legend-sample.burned {
            background: #e8e8e8;
            border-left-color: #666;
            opacity: 0.4;
        }

        .results-header {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .results-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .toggle-switch input[type="checkbox"] {
            width: 50px;
            height: 26px;
            position: relative;
            -webkit-appearance: none;
            background: #e2e8f0;
            outline: none;
            border-radius: 13px;
            cursor: pointer;
            transition: 0.3s;
        }

        .toggle-switch input:checked {
            background: var(--primary);
        }

        .toggle-switch input:before {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            background: white;
            transition: 0.3s;
        }

        .toggle-switch input:checked:before {
            left: 26px;
        }

        /* DPE Cards */
        .dpe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .dpe-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-left: 4px solid var(--info);
            transition: all 0.3s;
            position: relative;
        }

        .dpe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .dpe-card.visited-by-other {
            opacity: 0.7;
            border-left-color: var(--warning);
            background: #fffbf0;
        }

        .dpe-card.visited-by-me {
            opacity: 0.6;
            border-left-color: var(--gray);
            background: #f5f5f5;
        }

        .dpe-card.interested-by-me {
            border-left-color: var(--success);
            background: #f0fff4;
        }

        .dpe-card.burned {
            opacity: 0.4;
            filter: grayscale(50%);
        }

        .dpe-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .dpe-address {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            flex: 1;
        }

        .dpe-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-new {
            background: var(--info);
            color: white;
        }

        .badge-interested {
            background: var(--success);
            color: white;
        }

        .badge-visited-other {
            background: var(--warning);
            color: white;
        }

        .badge-visited-me {
            background: var(--gray);
            color: white;
        }

        .badge-burned {
            background: #666;
            color: white;
        }

        .dpe-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .dpe-detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--gray);
        }

        .dpe-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        /* Map Styles */
        #map {
            height: calc(100vh - 200px);
            width: 100%;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .map-controls {
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .map-btn {
            background: white;
            border: none;
            padding: 12px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .map-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .map-filter-panel {
            position: absolute;
            top: 80px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 250px;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .filter-header h3 {
            font-size: 16px;
            color: var(--dark);
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .filter-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Mission du Jour */
        .mission-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .mission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .mission-header h2 {
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mission-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .mission-stat {
            text-align: center;
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
        }

        .mission-stat-value {
            font-size: 24px;
            font-weight: 700;
            display: block;
        }

        .mission-stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .mission-list {
            background: white;
            color: var(--dark);
            padding: 20px;
            border-radius: 10px;
        }

        .mission-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.3s;
        }

        .mission-item:hover {
            background: var(--light);
        }

        .mission-number {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .mission-item.completed .mission-number {
            background: var(--success);
        }

        .mission-info {
            flex: 1;
        }

        .mission-address {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .mission-time {
            font-size: 13px;
            color: var(--gray);
        }

        /* Dashboard Personnel */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--gray);
        }

        /* Gamification */
        .achievements-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .achievement {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }

        .achievement.unlocked {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            border-color: #ffd89b;
            transform: scale(1.05);
        }

        .achievement-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .achievement-name {
            font-size: 13px;
            font-weight: 600;
        }

        .achievement-desc {
            font-size: 11px;
            margin-top: 5px;
            opacity: 0.8;
        }

        /* Leaderboard */
        .leaderboard {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .leaderboard-rank {
            width: 40px;
            height: 40px;
            background: var(--light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
        }

        .leaderboard-rank.gold {
            background: linear-gradient(135deg, #ffd89b 0%, #f9a825 100%);
            color: white;
        }

        .leaderboard-rank.silver {
            background: linear-gradient(135deg, #e0e0e0 0%, #9e9e9e 100%);
            color: white;
        }

        .leaderboard-rank.bronze {
            background: linear-gradient(135deg, #ffab91 0%, #d84315 100%);
            color: white;
        }

        .leaderboard-name {
            flex: 1;
            font-weight: 600;
        }

        .leaderboard-score {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        /* Photos et Notes */
        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-notes-list {
            margin: 15px 0;
        }

        .voice-note {
            background: var(--light);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .voice-note-play {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 16px;
        }

        .voice-note-info {
            flex: 1;
        }

        .voice-note-text {
            font-size: 14px;
            margin-bottom: 3px;
        }

        .voice-note-date {
            font-size: 12px;
            color: var(--gray);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 20px;
            color: var(--primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        /* Loading */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .dpe-grid {
                grid-template-columns: 1fr;
            }

            .map-filter-panel {
                left: 10px;
                right: 10px;
                max-width: none;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .mission-stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Contact Card */
        .contact-info {
            background: var(--light);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .contact-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .contact-label {
            color: var(--gray);
            font-weight: 600;
        }

        .contact-value {
            color: var(--dark);
        }

        /* Mode Surprise */
        .surprise-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(245, 87, 108, 0.3);
        }

        .surprise-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .surprise-card h2 {
            font-size: 24px;
            margin-bottom: 15px;
        }

        .surprise-card p {
            margin-bottom: 25px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- Auth Screen -->
    <div class="auth-screen active" id="authScreen">
        <div class="login-card">
            <h2>üè† DPE Pro</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="votre.email@exemple.fr" required>
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    üîê Se connecter
                </button>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <div class="header">
            <h1>üè† DPE Pro - Mega Ultime</h1>
            <div class="user-info">
                <div class="user-badge" id="userBadge">
                    <span id="userName">Utilisateur</span>
                </div>
                <button class="btn btn-small btn-danger" id="logoutBtn" onclick="logout()">
                    üö™ D√©connexion
                </button>
            </div>
        </div>

        <div class="container">
            <!-- Home Screen -->
            <div class="screen" id="homeScreen">
                <div class="search-section">
                    <h2>üîç Rechercher des DPE</h2>
                    <form id="searchForm">
                        <div class="form-group">
                            <label>Code postal</label>
                            <input type="text" id="postalCode" placeholder="76260, 76600..." required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            üîç Lancer la recherche
                        </button>
                    </form>
                </div>

                <!-- Surprise Button -->
                <div class="surprise-card">
                    <div class="surprise-icon">üé≤</div>
                    <h2>Mode "Surprise moi !"</h2>
                    <p>Trouvez le bien le plus proche non visit√©</p>
                    <button class="btn btn-secondary" onclick="surpriseMe()">
                        üé≤ Surprise moi !
                    </button>
                </div>
            </div>

            <!-- Results Screen -->
            <div class="screen hidden" id="resultsScreen">
                <!-- L√©gende -->
                <div class="legend">
                    <h3>üìå L√©gende des statuts</h3>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-sample new">üÜï</div>
                            <span>Nouveau bien</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-sample interested">‚≠ê</div>
                            <span>Vous √™tes int√©ress√©</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-sample visited-other">üëÅÔ∏è</div>
                            <span>Vu par un coll√®gue</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-sample visited-me">‚úÖ</div>
                            <span>Vous avez visit√©</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-sample burned">üî•</div>
                            <span>Bien br√ªl√©</span>
                        </div>
                    </div>
                </div>

                <!-- Results Header -->
                <div class="results-header">
                    <div class="results-stats">
                        <div class="stat-item">
                            <strong>üÜï <span id="newCount">0</span></strong> Nouveaux
                        </div>
                        <div class="stat-item">
                            <strong>üëÅÔ∏è <span id="seenCount">0</span></strong> D√©j√† vus
                        </div>
                    </div>
                    <div class="toggle-switch">
                        <span>Masquer les vus</span>
                        <input type="checkbox" id="hideSeen" onchange="toggleSeenProperties()">
                    </div>
                </div>

                <button class="btn btn-info" style="margin-bottom: 20px;" onclick="showScreen('mapScreen')">
                    üó∫Ô∏è Voir sur la carte
                </button>

                <!-- DPE Grid -->
                <div class="dpe-grid" id="dpeGrid"></div>
            </div>

            <!-- Map Screen -->
            <div class="screen hidden" id="mapScreen">
                <button class="btn btn-secondary" style="margin-bottom: 15px;" onclick="showScreen('resultsScreen')">
                    ‚Üê Retour aux r√©sultats
                </button>
                
                <!-- Map Filter Panel -->
                <div class="map-filter-panel" id="mapFilterPanel">
                    <div class="filter-header">
                        <h3>üéõÔ∏è Filtres</h3>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filterNew" checked onchange="updateMapFilters()">
                        <label>üÜï Nouveaux</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filterInterested" checked onchange="updateMapFilters()">
                        <label>‚≠ê Int√©ress√©s</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filterVisitedOther" checked onchange="updateMapFilters()">
                        <label>üëÅÔ∏è Vus par coll√®gue</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filterVisitedMe" checked onchange="updateMapFilters()">
                        <label>‚úÖ Vus par moi</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filterBurned" onchange="updateMapFilters()">
                        <label>üî• Biens br√ªl√©s</label>
                    </div>
                </div>

                <!-- Map Controls -->
                <div class="map-controls">
                    <button class="map-btn" onclick="locateMe()" title="Me localiser">üìç</button>
                    <button class="map-btn" onclick="fitAllMarkers()" title="Voir tous les biens">üîç</button>
                    <button class="map-btn" onclick="toggleHeatmap()" title="Heatmap" id="heatmapBtn">üî•</button>
                    <button class="map-btn" onclick="toggleDrawing()" title="Dessiner une zone" id="drawBtn">‚úèÔ∏è</button>
                </div>

                <div id="map"></div>
            </div>

            <!-- Mission Screen -->
            <div class="screen hidden" id="missionScreen">
                <div class="mission-card">
                    <div class="mission-header">
                        <h2>üéØ Mission du Jour</h2>
                        <button class="btn btn-secondary btn-small" onclick="generateMission()">
                            üîÑ G√©n√©rer
                        </button>
                    </div>
                    <div class="mission-stats">
                        <div class="mission-stat">
                            <span class="mission-stat-value" id="missionCount">0</span>
                            <span class="mission-stat-label">Biens √† visiter</span>
                        </div>
                        <div class="mission-stat">
                            <span class="mission-stat-value" id="missionDistance">0 km</span>
                            <span class="mission-stat-label">Distance totale</span>
                        </div>
                        <div class="mission-stat">
                            <span class="mission-stat-value" id="missionTime">0h00</span>
                            <span class="mission-stat-label">Temps estim√©</span>
                        </div>
                    </div>
                </div>

                <div class="mission-list" id="missionList">
                    <p style="text-align: center; color: var(--gray); padding: 40px;">
                        Cliquez sur "G√©n√©rer" pour cr√©er votre mission du jour
                    </p>
                </div>
            </div>

            <!-- Dashboard Screen -->
            <div class="screen hidden" id="dashboardScreen">
                <h2 style="color: white; margin-bottom: 20px;">üìä Votre Dashboard</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üîç</div>
                        <div class="stat-value" id="dashSearches">0</div>
                        <div class="stat-label">Recherches</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="dashVisits">0</div>
                        <div class="stat-label">Visites</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚≠ê</div>
                        <div class="stat-value" id="dashInterested">0</div>
                        <div class="stat-label">Int√©ress√©s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üèÜ</div>
                        <div class="stat-value" id="dashConversion">0%</div>
                        <div class="stat-label">Conversion</div>
                    </div>
                </div>

                <!-- Achievements -->
                <div class="achievements-section">
                    <h3>üèÜ Vos Achievements</h3>
                    <div class="achievement-grid" id="achievementGrid"></div>
                </div>

                <!-- Leaderboard -->
                <div class="leaderboard">
                    <h3 style="margin-bottom: 20px;">ü•á Classement du Mois</h3>
                    <div id="leaderboardList"></div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="showScreen('homeScreen')">
                <span class="nav-item-icon">üè†</span>
                Accueil
            </div>
            <div class="nav-item" onclick="showScreen('missionScreen')">
                <span class="nav-item-icon">üéØ</span>
                Mission
            </div>
            <div class="nav-item" onclick="showScreen('mapScreen')">
                <span class="nav-item-icon">üó∫Ô∏è</span>
                Carte
            </div>
            <div class="nav-item" onclick="showScreen('dashboardScreen')">
                <span class="nav-item-icon">üìä</span>
                Stats
            </div>
        </div>
    </div>

    <!-- Modal DPE Details -->
    <div class="modal" id="dpeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">D√©tails du bien</h3>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, orderBy, limit, getDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDtwxmL0PciBpdadVu4enNCsO8PZK6_UNA",
            authDomain: "dpe-pro-2a-immo.firebaseapp.com",
            projectId: "dpe-pro-2a-immo",
            storageBucket: "dpe-pro-2a-immo.firebasestorage.app",
            messagingSenderId: "392895190727",
            appId: "1:392895190727:web:dfb5aa9d32d3ded479d0e2",
            measurementId: "G-X3CEF7KEDZ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables globales
        window.currentUser = null;
        window.currentResults = [];
        window.map = null;
        window.markers = [];
        window.userMarker = null;
        window.heatmapLayer = null;
        window.drawControl = null;
        window.drawnItems = null;
        window.currentMission = [];

        // Achievements d√©finitions
        const achievements = [
            { id: 'first_visit', name: 'Premi√®re Visite', icon: 'üéØ', desc: 'Visitez votre premier bien', unlocked: false },
            { id: 'ten_visits', name: '10 Visites', icon: 'üîü', desc: 'Effectuez 10 visites', unlocked: false },
            { id: 'first_interested', name: 'Premier Int√©ress√©', icon: '‚≠ê', desc: 'Marquez votre premier int√©ress√©', unlocked: false },
            { id: 'daily_5', name: 'Productif', icon: 'üí™', desc: '5 visites en une journ√©e', unlocked: false },
            { id: 'explorer', name: 'Explorateur', icon: 'üó∫Ô∏è', desc: 'Visitez 5 communes diff√©rentes', unlocked: false },
            { id: 'hundred_visits', name: 'Centurion', icon: 'üíØ', desc: '100 visites totales', unlocked: false },
            { id: 'week_streak', name: 'Assidu', icon: 'üî•', desc: '7 jours cons√©cutifs', unlocked: false },
            { id: 'team_player', name: 'Esprit d\'√©quipe', icon: 'üë•', desc: '10 notes partag√©es', unlocked: false }
        ];

        // Auth
        window.logout = function() {
            signOut(auth);
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                // Charger le profil utilisateur
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    document.getElementById('userName').textContent = userData.name || user.email;
                }
                document.getElementById('authScreen').classList.remove('active');
                document.getElementById('mainContent').classList.add('active');
                loadDashboardStats();
            } else {
                document.getElementById('authScreen').classList.add('active');
                document.getElementById('mainContent').classList.remove('active');
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            showLoading(true);
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert('Erreur de connexion: ' + error.message);
            }
            showLoading(false);
        });

        // Search
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const postalCode = document.getElementById('postalCode').value;
            await searchDPE(postalCode);
        });

        async function searchDPE(postalCode) {
            showLoading(true);
            
            try {
                // Enregistrer la recherche
                try {
                    await addDoc(collection(db, 'searches'), {
                        userId: window.currentUser.uid,
                        postalCode: postalCode,
                        timestamp: Timestamp.now()
                    });
                } catch (firestoreError) {
                    console.warn('Firestore write error (non-blocking):', firestoreError);
                    alert('‚ö†Ô∏è Impossible d\'enregistrer la recherche. V√©rifiez les r√®gles Firestore.\n\nLa recherche va continuer...');
                }

                // API ADEME pour les DPE
                console.log('Recherche DPE pour code postal:', postalCode);
                const response = await fetch(`https://data.ademe.fr/data-fair/api/v1/datasets/dpe-v2-logements-existants/lines?size=100&select=Adresse_(BAN),Commune_(BAN),Code_postal_(BAN),Etiquette_DPE,Surface_habitable_logement&q=${postalCode}`);
                
                if (!response.ok) {
                    throw new Error(`API ADEME error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Donn√©es re√ßues:', data);
                
                window.currentResults = data.results || [];
                
                if (window.currentResults.length === 0) {
                    alert(`‚ùå Aucun DPE trouv√© pour le code postal ${postalCode}.\n\nEssayez un autre code postal (ex: 76600, 76260, 76000)`);
                    showLoading(false);
                    return;
                }
                
                // Charger les notes existantes
                try {
                    const notesSnapshot = await getDocs(collection(db, 'notes'));
                    const existingNotes = {};
                    notesSnapshot.forEach(doc => {
                        const note = doc.data();
                        const key = `${note.address}_${note.city}`;
                        if (!existingNotes[key]) existingNotes[key] = [];
                        existingNotes[key].push(note);
                    });
                    
                    // Enrichir les r√©sultats avec les notes
                    window.currentResults.forEach(result => {
                        const key = `${result['Adresse_(BAN)']}_${result['Commune_(BAN)']}`;
                        result.notes = existingNotes[key] || [];
                        result.status = determineStatus(result.notes);
                    });
                } catch (notesError) {
                    console.warn('Erreur chargement notes:', notesError);
                    // Continuer sans les notes
                    window.currentResults.forEach(result => {
                        result.notes = [];
                        result.status = 'new';
                    });
                }
                
                displayResults();
                showScreen('resultsScreen');
                
            } catch (error) {
                console.error('Erreur recherche DPE:', error);
                alert(`‚ùå Erreur lors de la recherche:\n${error.message}\n\nV√©rifiez:\n1. Votre connexion Internet\n2. Les r√®gles Firestore\n3. Le code postal (format: 76600)`);
            } finally {
                showLoading(false);
            }
        }

        function determineStatus(notes) {
            if (!notes || notes.length === 0) return 'new';
            
            const currentUserId = window.currentUser.uid;
            const myNotes = notes.filter(n => n.userId === currentUserId);
            const othersNotes = notes.filter(n => n.userId !== currentUserId);
            
            // Int√©ress√© par moi
            if (myNotes.some(n => n.status === 'interested')) return 'interested-by-me';
            
            // Visit√© par moi
            if (myNotes.some(n => n.status === 'visited')) return 'visited-by-me';
            
            // Bien br√ªl√© (vu par 2+ personnes)
            if (notes.length >= 2 && othersNotes.length > 0) return 'burned';
            
            // Vu par un coll√®gue
            if (othersNotes.length > 0) return 'visited-by-other';
            
            return 'new';
        }

        function displayResults() {
            const grid = document.getElementById('dpeGrid');
            grid.innerHTML = '';
            
            let newCount = 0;
            let seenCount = 0;
            
            window.currentResults.forEach((result, index) => {
                const status = result.status || 'new';
                if (status === 'new') newCount++;
                else seenCount++;
                
                const card = createDPECard(result, index);
                grid.appendChild(card);
            });
            
            document.getElementById('newCount').textContent = newCount;
            document.getElementById('seenCount').textContent = seenCount;
        }

        function createDPECard(dpe, index) {
            const card = document.createElement('div');
            card.className = `dpe-card ${dpe.status}`;
            card.dataset.index = index;
            
            const statusBadge = {
                'new': { text: 'üÜï Nouveau', class: 'badge-new' },
                'interested-by-me': { text: '‚≠ê Int√©ress√©', class: 'badge-interested' },
                'visited-by-other': { text: `üëÅÔ∏è Vu par ${dpe.notes[0]?.userName || 'coll√®gue'}`, class: 'badge-visited-other' },
                'visited-by-me': { text: '‚úÖ Visit√©', class: 'badge-visited-me' },
                'burned': { text: 'üî• Bien br√ªl√©', class: 'badge-burned' }
            }[dpe.status] || { text: 'üÜï Nouveau', class: 'badge-new' };
            
            card.innerHTML = `
                <div class="dpe-header">
                    <div class="dpe-address">${dpe['Adresse_(BAN)']}</div>
                    <span class="dpe-badge ${statusBadge.class}">${statusBadge.text}</span>
                </div>
                <div class="dpe-details">
                    <div class="dpe-detail-item">
                        <span>üìç ${dpe['Commune_(BAN)']}</span>
                    </div>
                    <div class="dpe-detail-item">
                        <span>üìÆ ${dpe['Code_postal_(BAN)']}</span>
                    </div>
                    <div class="dpe-detail-item">
                        <span>‚ö° Classe ${dpe['Etiquette_DPE']}</span>
                    </div>
                    <div class="dpe-detail-item">
                        <span>üìê ${dpe['Surface_habitable_logement']} m¬≤</span>
                    </div>
                </div>
                <div class="dpe-actions">
                    <button class="action-btn btn-success" onclick="markAsInterested(${index})">
                        ‚≠ê Int√©ress√©
                    </button>
                    <button class="action-btn btn-warning" onclick="markAsVisited(${index})">
                        ‚úÖ Visit√©
                    </button>
                    <button class="action-btn btn-info" onclick="openDPEDetails(${index})">
                        üìù D√©tails
                    </button>
                </div>
            `;
            
            return card;
        }

        window.markAsInterested = async function(index) {
            await saveNote(index, 'interested');
        };

        window.markAsVisited = async function(index) {
            await saveNote(index, 'visited');
        };

        async function saveNote(index, status) {
            const dpe = window.currentResults[index];
            showLoading(true);
            
            try {
                await addDoc(collection(db, 'notes'), {
                    userId: window.currentUser.uid,
                    userName: window.currentUser.displayName || window.currentUser.email,
                    address: dpe['Adresse_(BAN)'],
                    city: dpe['Commune_(BAN)'],
                    postalCode: dpe['Code_postal_(BAN)'],
                    status: status,
                    timestamp: Timestamp.now()
                });
                
                // Recharger les r√©sultats
                await searchDPE(dpe['Code_postal_(BAN)']);
                checkAchievements();
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
            
            showLoading(false);
        }

        window.openDPEDetails = function(index) {
            const dpe = window.currentResults[index];
            const modal = document.getElementById('dpeModal');
            document.getElementById('modalTitle').textContent = dpe['Adresse_(BAN)'];
            
            let notesHTML = '';
            if (dpe.notes && dpe.notes.length > 0) {
                notesHTML = '<h4>üìù Notes de l\'√©quipe</h4>';
                dpe.notes.forEach(note => {
                    notesHTML += `
                        <div class="voice-note">
                            <div class="voice-note-info">
                                <div class="voice-note-text"><strong>${note.userName}</strong> - ${note.status === 'interested' ? '‚≠ê Int√©ress√©' : '‚úÖ Visit√©'}</div>
                                <div class="voice-note-date">${new Date(note.timestamp?.toDate()).toLocaleDateString()}</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('modalBody').innerHTML = `
                <div class="dpe-details">
                    <div class="dpe-detail-item">üìç ${dpe['Commune_(BAN)']}</div>
                    <div class="dpe-detail-item">üìÆ ${dpe['Code_postal_(BAN)']}</div>
                    <div class="dpe-detail-item">‚ö° Classe ${dpe['Etiquette_DPE']}</div>
                    <div class="dpe-detail-item">üìê ${dpe['Surface_habitable_logement']} m¬≤</div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-info" onclick="openRoute('${dpe['Adresse_(BAN)']}, ${dpe['Commune_(BAN)']}')">
                        üß≠ Itin√©raire GPS
                    </button>
                </div>
                ${notesHTML}
                <div style="margin-top: 20px;">
                    <h4>üì∏ Ajouter une photo</h4>
                    <input type="file" accept="image/*" capture="environment" class="form-group" onchange="uploadPhoto(${index}, this)">
                </div>
            `;
            
            modal.classList.add('active');
        };

        window.closeModal = function() {
            document.getElementById('dpeModal').classList.remove('active');
        };

        window.openRoute = function(address) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address)}`;
            window.open(url, '_blank');
        };

        // Mission du Jour
        window.generateMission = async function() {
            if (window.currentResults.length === 0) {
                alert('Lancez d\'abord une recherche pour g√©n√©rer une mission !');
                return;
            }
            
            showLoading(true);
            
            // Obtenir position utilisateur
            navigator.geolocation.getCurrentPosition(async (position) => {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;
                
                // Filtrer les biens non visit√©s
                const unvisited = window.currentResults.filter(dpe => 
                    dpe.status === 'new' || dpe.status === 'visited-by-other'
                );
                
                // G√©ocoder et calculer distances
                const propertiesWithDistance = [];
                for (const dpe of unvisited) {
                    const coords = await geocodeAddress(dpe['Adresse_(BAN)'], dpe['Commune_(BAN)']);
                    if (coords) {
                        const distance = calculateDistance(userLat, userLon, coords.lat, coords.lon);
                        propertiesWithDistance.push({ dpe, coords, distance });
                    }
                }
                
                // Trier par distance (algorithme simple du plus proche)
                propertiesWithDistance.sort((a, b) => a.distance - b.distance);
                
                // Prendre les 12 premiers
                window.currentMission = propertiesWithDistance.slice(0, 12);
                
                // Calculer stats
                const totalDistance = window.currentMission.reduce((sum, p) => sum + p.distance, 0);
                const totalTime = totalDistance * 3; // 3 min par km + temps de visite
                
                document.getElementById('missionCount').textContent = window.currentMission.length;
                document.getElementById('missionDistance').textContent = totalDistance.toFixed(1) + ' km';
                document.getElementById('missionTime').textContent = Math.floor(totalTime / 60) + 'h' + String(Math.floor(totalTime % 60)).padStart(2, '0');
                
                displayMissionList();
                showLoading(false);
            }, () => {
                alert('Impossible d\'obtenir votre position');
                showLoading(false);
            });
        };

        function displayMissionList() {
            const list = document.getElementById('missionList');
            list.innerHTML = '';
            
            window.currentMission.forEach((item, index) => {
                const missionItem = document.createElement('div');
                missionItem.className = 'mission-item';
                missionItem.innerHTML = `
                    <div class="mission-number">${index + 1}</div>
                    <div class="mission-info">
                        <div class="mission-address">${item.dpe['Adresse_(BAN)']}, ${item.dpe['Commune_(BAN)']}</div>
                        <div class="mission-time">üìç ${item.distance.toFixed(1)} km - Classe ${item.dpe['Etiquette_DPE']}</div>
                    </div>
                    <button class="btn btn-small btn-info" onclick="openRoute('${item.dpe['Adresse_(BAN)']}, ${item.dpe['Commune_(BAN)']}')">
                        üß≠
                    </button>
                `;
                list.appendChild(missionItem);
            });
        }

        // Surprise Me
        window.surpriseMe = function() {
            if (window.currentResults.length === 0) {
                alert('Lancez d\'abord une recherche !');
                return;
            }
            
            showLoading(true);
            navigator.geolocation.getCurrentPosition(async (position) => {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;
                
                // Trouver le bien non visit√© le plus proche
                let closest = null;
                let minDistance = Infinity;
                
                for (const dpe of window.currentResults) {
                    if (dpe.status === 'new' || dpe.status === 'visited-by-other') {
                        const coords = await geocodeAddress(dpe['Adresse_(BAN)'], dpe['Commune_(BAN)']);
                        if (coords) {
                            const distance = calculateDistance(userLat, userLon, coords.lat, coords.lon);
                            if (distance < minDistance) {
                                minDistance = distance;
                                closest = dpe;
                            }
                        }
                    }
                }
                
                showLoading(false);
                
                if (closest) {
                    alert(`üé≤ Bien trouv√© √† ${minDistance.toFixed(1)} km !\n${closest['Adresse_(BAN)']}, ${closest['Commune_(BAN)']}\nClasse ${closest['Etiquette_DPE']}`);
                    openRoute(closest['Adresse_(BAN)'] + ', ' + closest['Commune_(BAN)']);
                } else {
                    alert('Aucun bien disponible √† proximit√© !');
                }
            }, () => {
                alert('Impossible d\'obtenir votre position');
                showLoading(false);
            });
        };

        // Dashboard
        async function loadDashboardStats() {
            const userId = window.currentUser.uid;
            
            // Compter les recherches
            const searchesSnapshot = await getDocs(query(collection(db, 'searches'), where('userId', '==', userId)));
            document.getElementById('dashSearches').textContent = searchesSnapshot.size;
            
            // Compter les notes
            const notesSnapshot = await getDocs(query(collection(db, 'notes'), where('userId', '==', userId)));
            let visits = 0;
            let interested = 0;
            
            notesSnapshot.forEach(doc => {
                const note = doc.data();
                if (note.status === 'visited') visits++;
                if (note.status === 'interested') interested++;
            });
            
            document.getElementById('dashVisits').textContent = visits;
            document.getElementById('dashInterested').textContent = interested;
            
            const conversion = visits > 0 ? Math.round((interested / visits) * 100) : 0;
            document.getElementById('dashConversion').textContent = conversion + '%';
            
            // Achievements
            displayAchievements(visits, interested);
            
            // Leaderboard
            await loadLeaderboard();
        }

        function displayAchievements(visits, interested) {
            const grid = document.getElementById('achievementGrid');
            grid.innerHTML = '';
            
            achievements.forEach(achievement => {
                let unlocked = false;
                
                if (achievement.id === 'first_visit' && visits >= 1) unlocked = true;
                if (achievement.id === 'ten_visits' && visits >= 10) unlocked = true;
                if (achievement.id === 'hundred_visits' && visits >= 100) unlocked = true;
                if (achievement.id === 'first_interested' && interested >= 1) unlocked = true;
                
                const div = document.createElement('div');
                div.className = `achievement ${unlocked ? 'unlocked' : ''}`;
                div.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-desc">${achievement.desc}</div>
                `;
                grid.appendChild(div);
            });
        }

        async function loadLeaderboard() {
            const notesSnapshot = await getDocs(collection(db, 'notes'));
            const userScores = {};
            
            notesSnapshot.forEach(doc => {
                const note = doc.data();
                if (!userScores[note.userId]) {
                    userScores[note.userId] = { name: note.userName, score: 0 };
                }
                userScores[note.userId].score += note.status === 'interested' ? 3 : 1;
            });
            
            const sorted = Object.values(userScores).sort((a, b) => b.score - a.score);
            
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '';
            
            sorted.forEach((user, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                
                let rankClass = '';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';
                
                item.innerHTML = `
                    <div class="leaderboard-rank ${rankClass}">${index + 1}</div>
                    <div class="leaderboard-name">${user.name}</div>
                    <div class="leaderboard-score">${user.score} pts</div>
                `;
                list.appendChild(item);
            });
        }

        async function checkAchievements() {
            // Recharger les stats pour v√©rifier les achievements
            await loadDashboardStats();
        }

        // Utilities
        async function geocodeAddress(address, city) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', ' + city)}`);
                const data = await response.json();
                if (data && data.length > 0) {
                    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
            return null;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Rayon de la Terre en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        window.showScreen = function(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (screenId === 'homeScreen') document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            if (screenId === 'missionScreen') document.querySelector('.nav-item:nth-child(2)').classList.add('active');
            if (screenId === 'mapScreen') {
                document.querySelector('.nav-item:nth-child(3)').classList.add('active');
                initMap();
            }
            if (screenId === 'dashboardScreen') document.querySelector('.nav-item:nth-child(4)').classList.add('active');
        };

        window.toggleSeenProperties = function() {
            const hide = document.getElementById('hideSeen').checked;
            document.querySelectorAll('.dpe-card').forEach(card => {
                const status = card.classList.contains('visited-by-me') || 
                               card.classList.contains('visited-by-other') || 
                               card.classList.contains('burned');
                if (hide && status && !card.classList.contains('interested-by-me')) {
                    card.style.display = 'none';
                } else {
                    card.style.display = 'block';
                }
            });
        };

        // Map Functions
        window.initMap = function() {
            if (window.map) return;
            
            window.map = L.map('map').setView([49.5, 0.1], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            }).addTo(window.map);
            
            // Cluster group
            window.markers = L.markerClusterGroup();
            window.map.addLayer(window.markers);
            
            // Drawn items
            window.drawnItems = new L.FeatureGroup();
            window.map.addLayer(window.drawnItems);
            
            locateMe();
            updateMapMarkers();
        };

        window.locateMe = function() {
            if (!window.map) return;
            
            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                if (window.userMarker) {
                    window.map.removeLayer(window.userMarker);
                }
                
                window.userMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div style="background: #4facfe; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>',
                        iconSize: [20, 20]
                    })
                }).addTo(window.map);
                
                window.map.setView([lat, lon], 13);
            });
        };

        async function updateMapMarkers() {
            if (!window.map) return;
            
            window.markers.clearLayers();
            
            for (const dpe of window.currentResults) {
                const coords = await geocodeAddress(dpe['Adresse_(BAN)'], dpe['Commune_(BAN)']);
                if (coords) {
                    const color = {
                        'new': '#4facfe',
                        'interested-by-me': '#38ef7d',
                        'visited-by-other': '#fdb913',
                        'visited-by-me': '#999',
                        'burned': '#666'
                    }[dpe.status] || '#4facfe';
                    
                    const marker = L.marker([coords.lat, coords.lon], {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: `<div style="background: ${color}; width: 25px; height: 25px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>`,
                            iconSize: [25, 25]
                        })
                    });
                    
                    marker.bindPopup(`
                        <strong>${dpe['Adresse_(BAN)']}</strong><br>
                        ${dpe['Commune_(BAN)']}<br>
                        Classe ${dpe['Etiquette_DPE']} - ${dpe['Surface_habitable_logement']} m¬≤
                    `);
                    
                    window.markers.addLayer(marker);
                }
            }
        }

        window.fitAllMarkers = function() {
            if (window.markers.getLayers().length > 0) {
                window.map.fitBounds(window.markers.getBounds());
            }
        };

        window.updateMapFilters = function() {
            // Impl√©mentation des filtres carte
            updateMapMarkers();
        };

        window.toggleHeatmap = function() {
            alert('Heatmap - Fonctionnalit√© √† impl√©menter avec leaflet.heat');
        };

        window.toggleDrawing = function() {
            alert('Mode dessin - Fonctionnalit√© √† impl√©menter avec leaflet-draw');
        };
    </script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
</body>
</html>
